# 개요
## 배경: DC 전력선 통신(Line-Fi)
> 전력선을 통해 데이터를 전송하는 기술로 DC 전력선을 사용한다.

- 다운 링크: 전력선의 전압 극성을 변경하여 데이터 패킷 전송 (VSC)
- 업 링크: 전력선의 전류 극성을 변경하여 데이터 패킷 전송 (CSC)

## 고려 사항
- 마스터는 모든 슬레이브에게 신호를 보낼 수 있다.
- 슬레이브는 마스터에게만 신호를 보낼 수 있다.
- 두 개 이상의 슬레이브가 동시에 데이터를 보내면
	- 신호가 충돌하거나 손상된다.
	- 마스터는 해독 불가능하다.
	- 두 개의 슬레이브는 데이터를 동시에 전송해서는 안된다.
- 마스터와 슬레이브는 동시에 전송할 수 있다
	- 두 개의 양방향 통신이 작동한다고 가정

## 통신 시나리오

<Bbox> 마스터 -> 슬레이브 </Bbox>
- 마스터는 모든 슬레이브에게 무언가를 보낼 수 있다.
- 마스터는 특정 슬레이브에게 무언가를 보낼 수 있다.
- (선택 사항) 마스터는 몇몇 슬레이브에게 무언가를 보낼 수 있다.

<Bbox> 슬레이브 -> 마스터 </Bbox>
- 슬레이브는 마스터에게만 무언가를 보낼 수 있다.
- (선택 사항) 슬레이브는 다른 슬레이브에게 무언가를 보낼 수 있다.

<Bbox> 트래픽 패턴 </Bbox>
- 주기적일 수 있다 (예: 매 100ms 마다 무언가를 전송)
- 비주기적일 수 있다 (예: 이벤트 발생 시 전송)

## 시스템 요구 사항
1. 마스터 -> 슬레이브
	- 마스터는 모든 슬레이브에게 패킷을 보낼 수 있다.
2. 슬레이브 -> 마스터
	- 슬레이브는 마스터에게만 패킷을 보낼 수 있다.
3. 슬레이브 간 충돌
	- 두 개 이상의 슬레이브가 동시에 패킷을 전송하면 충돌/손상이 발생하고 마스터는 이를 해독할 수 없다.
	- 따라서 두 슬레이브는 동시간에 패킷을 전송해서는 안된다.
4. 동시 전송
	- 마스터와 슬레이브는 동시에 전송할 수 있다.
	- 동시에 양방향 통신이 가능하다고 가정
5. 주소 지정
	- 각 장치는 고유한 2바이트 주소를 가지고 있다 (N \<\< 100~200)
6. 캐리어 감지 불가
	- 캐리어 감지 기능이 없으므로 CCA/CSMA를 사용할 수 없다.
7. 전송 속도
	- 다운링크 전송 속도: 1kbps
	- 업링크 전송 속도: 2kbps

## 디자인 질문
> 시스템의 기본 요구 사항을 고려할 때, 마스터와 슬레이브를 위한 양방향 통신 프로토콜과 알고리즘을 어떻게 설계할 것인가?

- 두 명 이상의 슬레이브가 동시에 전송해서는 안 되는 경우, 슬레이브는 충돌을 피하기 위해 언제 전송해야 하는가? 얼마나 자주(빠르게) 전송할 수 있는가?
- 마스터는 언제 전송해야 하는가?
- 시스템은 비트 오류를 어떻게 처리해야 하는가?
- 시스템은 패킷 손실을 어떻게 처리해야 하는가?
- 패킷 형식은 어떻게 되어야 하는가? 헤더에 어떤 정보가 포함되어야 하는가?
- 설계는 OSI 7계층의 2계층과 3계층 주위에 있을 것이다.

## 추가 요구사항
>이전에는 '패킷'이라고 했지만, 마스터와 슬레이브는 전압/전류 '신호'를 전송하며 이 신호는 '비트'로 디코딩될 수 있다.

디바이스가 신호로부터 패킷을 신뢰성 있게 검출할 수 있도록 패킷 형식은 어떻게 되어야 하는가? (참고로 신호는 비트처럼 보일 수 있으며, '신호 없음'도 비트처럼 보일 수 있다)
예시: 프리엠블? SFD? CRC/체크섬? EFD? HDLC?
설계가 효율적인가? 활용도가 좋은가? 생각할 수 있는 모든 것...

- 예시: 시간을 최대한 낭비하지 않으려면 어떻게 해야 하는가?
- 예시: 슬레이브가 무언가를 전송하고 싶을 때 얼마나 기다려야 하는가?
- 예시: 슬레이브가 다른 슬레이브에게 패킷을 어떻게 보낼 수 있는가?
- 예시: 마스터가 한 번의 전송으로 여러 슬레이브에게 패킷을 어떻게 보낼 수 있는가?

# 설계

## 고려 사항에 대한 설계
주어진 조건을 반영하여 DC 전력선 통신을 위한 안정적이고 효율적인 프로토콜을 설계하겠습니다. 주요 고려 사항을 중심으로 각 계층에서의 설계를 세부적으로 진행하겠습니다.

### 1. 물리 계층 (Physical Layer)
- **변조 방식**: FSK (Frequency Shift Keying) 사용. FSK는 DC 전력선의 특성상 노이즈와 간섭에 강한 변조 방식입니다.
- **주파수 대역**: 10kHz ~ 500kHz의 저주파수 대역 사용.
- **채널 인코딩**: Hamming Code와 같은 간단한 오류 수정 코드 사용.

### 2. 데이터 링크 계층 (Data Link Layer)
- **프레이밍**: 
  - **헤더**: 송신자와 수신자의 주소, 프레임 번호, 제어 정보 포함.
  - **페이로드**: 실제 전송할 데이터.
  - **트레일러**: CRC를 이용한 오류 검출 정보 포함.
- **다중 접속 제어 (MAC)**: 
  - **CSMA/CA (Carrier Sense Multiple Access with Collision Avoidance)**: 슬레이브가 데이터를 전송하기 전에 채널 상태를 확인하여 충돌을 피함.
  - **슬레이브-마스터 통신 규칙**: 슬레이브는 마스터에게만 데이터를 전송할 수 있으며, 마스터는 모든 슬레이브에게 신호를 보낼 수 있음.
  - **충돌 방지 메커니즘**: 슬레이브가 데이터 전송을 시도할 때 일정 시간 랜덤 백오프 (Random Backoff) 적용 후 재시도.

### 3. 네트워크 계층 (Network Layer)
- **라우팅 프로토콜**: 간단한 트리 구조를 사용하여 각 슬레이브가 마스터를 통해 통신하도록 설정.
- **주소 지정**: 슬레이브와 마스터에게 고유한 주소를 할당. 예를 들어, 슬레이브 주소는 1부터 n까지, 마스터는 주소 0 할당.

### 4. 전송 계층 (Transport Layer)
- **전송 프로토콜**: UDP 사용. 슬레이브와 마스터 간의 비연결 지향 통신이므로 데이터 전송이 신속함.
- **신뢰성 보장**: 슬레이브는 데이터를 전송한 후 마스터로부터 ACK(acknowledgement) 응답을 기다림. 마스터가 응답하지 않으면 슬레이브는 데이터를 재전송.

### 5. 응용 계층 (Application Layer)
- **응용 프로토콜**: 스마트 미터링 또는 산업 자동화 응용을 위한 특화된 프로토콜 사용.
- **데이터 암호화**: AES-128을 사용하여 데이터의 기밀성을 유지.

### 6. 시스템 보안
- **인증**: 슬레이브와 마스터 간의 인증 절차를 통해 신뢰할 수 있는 통신 보장.
- **무결성**: 전송되는 데이터의 무결성을 보장하기 위해 HMAC (Hash-based Message Authentication Code) 사용.
- **기밀성**: 전송되는 데이터의 기밀성을 유지하기 위해 AES 암호화 사용.

### 7. 오류 처리 및 복구
- **오류 검출 및 수정**: 데이터 전송 중 발생할 수 있는 오류를 검출하고 수정하기 위한 CRC 및 Hamming Code 사용.
- **재전송 메커니즘**: 오류가 발생한 데이터를 슬레이브가 재전송하는 방식으로 신뢰성을 높임.

### 통신 흐름 예시
1. **마스터 -> 슬레이브**: 마스터는 슬레이브에게 데이터를 전송할 수 있으며, 여러 슬레이브에게 동시에 전송 가능.
2. **슬레이브 -> 마스터**: 슬레이브는 마스터에게 데이터를 전송하기 전에 CSMA/CA를 통해 채널 상태를 확인. 충돌이 발생하지 않도록 랜덤 백오프 적용.
3. **동시 전송 방지**: 슬레이브는 마스터로부터 ACK를 수신하지 못하면 랜덤 백오프 후 재전송 시도. 두 개의 슬레이브가 동시에 데이터를 전송하는 것을 방지.
4. **양방향 통신**: 마스터와 슬레이브는 동시에 데이터를 전송할 수 있으나, 슬레이브 간의 동시 전송은 금지됨.

이 설계를 통해 DC 전력선 통신 환경에서 안정적이고 효율적인 통신 프로토콜을 구현할 수 있습니다. 추가적인 세부 조건이나 요구 사항이 있다면 말씀해 주세요.

## 통신 시나리오에 대한 설계
주어진 통신 시나리오와 트래픽 패턴을 고려하여 DC 전력선 통신을 위한 안정적이고 효율적인 프로토콜을 설계해 보겠습니다.

### 1. 물리 계층 (Physical Layer)
- **변조 방식**: FSK (Frequency Shift Keying) 사용.
- **주파수 대역**: 10kHz ~ 500kHz의 저주파수 대역 사용.
- **채널 인코딩**: Hamming Code와 같은 간단한 오류 수정 코드 사용.

### 2. 데이터 링크 계층 (Data Link Layer)
- **프레이밍**: 
  - **헤더**: 송신자와 수신자의 주소, 프레임 번호, 제어 정보 포함.
  - **페이로드**: 실제 전송할 데이터.
  - **트레일러**: CRC를 이용한 오류 검출 정보 포함.
- **다중 접속 제어 (MAC)**: 
  - **CSMA/CA (Carrier Sense Multiple Access with Collision Avoidance)**: 슬레이브가 데이터를 전송하기 전에 채널 상태를 확인하여 충돌을 피함.
  - **슬레이브-마스터 통신 규칙**: 슬레이브는 마스터에게만 데이터를 전송할 수 있으며, 마스터는 모든 슬레이브에게 신호를 보낼 수 있음.
  - **충돌 방지 메커니즘**: 슬레이브가 데이터 전송을 시도할 때 일정 시간 랜덤 백오프 (Random Backoff) 적용 후 재시도.

### 3. 네트워크 계층 (Network Layer)
- **라우팅 프로토콜**: 트리 구조를 사용하여 각 슬레이브가 마스터를 통해 통신하도록 설정.
- **주소 지정**: 슬레이브와 마스터에게 고유한 주소를 할당. 예를 들어, 슬레이브 주소는 1부터 n까지, 마스터는 주소 0 할당.

### 4. 전송 계층 (Transport Layer)
- **전송 프로토콜**: UDP 사용. 슬레이브와 마스터 간의 비연결 지향 통신이므로 데이터 전송이 신속함.
- **신뢰성 보장**: 슬레이브는 데이터를 전송한 후 마스터로부터 ACK(acknowledgement) 응답을 기다림. 마스터가 응답하지 않으면 슬레이브는 데이터를 재전송.

### 5. 응용 계층 (Application Layer)
- **응용 프로토콜**: 스마트 미터링 또는 산업 자동화 응용을 위한 특화된 프로토콜 사용.
- **데이터 암호화**: AES-128을 사용하여 데이터의 기밀성을 유지.

### 6. 시스템 보안
- **인증**: 슬레이브와 마스터 간의 인증 절차를 통해 신뢰할 수 있는 통신 보장.
- **무결성**: 전송되는 데이터의 무결성을 보장하기 위해 HMAC (Hash-based Message Authentication Code) 사용.
- **기밀성**: 전송되는 데이터의 기밀성을 유지하기 위해 AES 암호화 사용.

### 7. 오류 처리 및 복구
- **오류 검출 및 수정**: 데이터 전송 중 발생할 수 있는 오류를 검출하고 수정하기 위한 CRC 및 Hamming Code 사용.
- **재전송 메커니즘**: 오류가 발생한 데이터를 슬레이브가 재전송하는 방식으로 신뢰성을 높임.

### 통신 시나리오 및 트래픽 패턴
#### 마스터 -> 슬레이브
1. **모든 슬레이브에게 전송**:
   - 마스터는 브로드캐스트 메시지를 사용하여 모든 슬레이브에게 데이터를 전송.
   - 프레임 헤더의 주소 필드를 브로드캐스트 주소로 설정.

2. **특정 슬레이브에게 전송**:
   - 마스터는 특정 슬레이브의 주소를 지정하여 데이터 전송.
   - 프레임 헤더의 주소 필드를 특정 슬레이브 주소로 설정.

3. **몇몇 슬레이브에게 전송 (선택 사항)**:
   - 마스터는 멀티캐스트 그룹을 설정하여 그룹에 속한 슬레이브들에게 데이터 전송.
   - 멀티캐스트 주소를 사용하여 데이터를 전송하며, 해당 주소를 받은 슬레이브들만 데이터 수신.

#### 슬레이브 -> 마스터
1. **마스터에게 전송**:
   - 슬레이브는 데이터를 전송하기 전에 CSMA/CA를 통해 채널 상태를 확인.
   - 충돌이 없으면 데이터를 마스터에게 전송.
   - 마스터로부터 ACK를 수신하여 전송 성공 여부 확인.

2. **다른 슬레이브에게 전송 (선택 사항)**:
   - 슬레이브가 다른 슬레이브에게 데이터를 전송할 수 있도록 특별한 주소 체계 사용.
   - 슬레이브 간 통신 시에도 CSMA/CA를 통해 충돌 방지.

### 트래픽 패턴
1. **주기적 트래픽**:
   - 일정한 간격으로 데이터 전송 (예: 매 100ms마다).
   - 슬레이브와 마스터 모두 주기적 데이터를 전송할 경우 타이밍을 조절하여 충돌 방지.

2. **비주기적 트래픽**:
   - 이벤트 발생 시 데이터 전송.
   - 비주기적 데이터 전송 시 CSMA/CA 메커니즘을 통해 충돌 방지.

### 전체 통신 흐름 예시
1. **주기적 데이터 전송**:
   - 마스터는 매 100ms마다 모든 슬레이브에게 브로드캐스트 메시지 전송.
   - 슬레이브는 이벤트 발생 시 데이터를 마스터에게 전송.

2. **비주기적 데이터 전송**:
   - 특정 이벤트 발생 시 마스터는 해당 슬레이브에게 데이터를 전송.
   - 슬레이브는 이벤트 발생 시 데이터를 마스터에게 전송.

이 설계를 통해 다양한 통신 시나리오와 트래픽 패턴에 대응할 수 있는 DC 전력선 통신 프로토콜을 구현할 수 있습니다. 추가적인 세부 조건이나 요구 사항이 있다면 말씀해 주세요.

## 시스템 요구사항에 대한 설계
주어진 시스템 요구 사항을 기반으로 DC 전력선 통신을 위한 프로토콜을 설계하겠습니다. 특히, 캐리어 감지 불가 상황을 고려하여 충돌을 방지하는 방법을 포함한 효율적인 프로토콜을 제안합니다.

### 시스템 요구 사항 요약
1. 마스터 -> 슬레이브: 모든 슬레이브에게 패킷 전송 가능.
2. 슬레이브 -> 마스터: 슬레이브는 마스터에게만 패킷 전송 가능.
3. 슬레이브 간 충돌: 두 개 이상의 슬레이브가 동시에 전송하면 충돌 발생.
4. 동시 전송: 마스터와 슬레이브는 동시에 전송 가능.
5. 주소 지정: 고유한 2바이트 주소 사용.
6. 캐리어 감지 불가: CCA/CSMA 불가.
7. 전송 속도: 다운링크 1kbps, 업링크 2kbps.

### 프로토콜 설계

#### 1. 물리 계층 (Physical Layer)
- **변조 방식**: FSK (Frequency Shift Keying)
- **주파수 대역**: 10kHz ~ 500kHz
- **채널 인코딩**: Hamming Code

#### 2. 데이터 링크 계층 (Data Link Layer)
- **프레이밍**:
  - **헤더**: 송신자 주소 (2바이트), 수신자 주소 (2바이트), 프레임 번호 (2바이트), 제어 정보 (1바이트)
  - **페이로드**: 전송할 데이터
  - **트레일러**: CRC (2바이트)
- **다중 접속 제어 (MAC)**:
  - **슬레이브 -> 마스터**: 충돌을 피하기 위한 타임 슬롯 기반 통신 사용.
  - **슬레이브 충돌 방지**: 슬레이브는 마스터로부터 할당된 타임 슬롯을 사용하여 통신. 타임 슬롯은 마스터가 주기적으로 할당.
  - **타임 슬롯 관리**: 마스터는 슬레이브들에게 주기적으로 타임 슬롯 할당 메시지를 브로드캐스트.

#### 3. 네트워크 계층 (Network Layer)
- **라우팅 프로토콜**: 각 장치가 고유한 주소를 사용하여 패킷 라우팅.
- **주소 지정**: 각 장치는 고유한 2바이트 주소 사용.

#### 4. 전송 계층 (Transport Layer)
- **전송 프로토콜**: UDP 사용
- **신뢰성 보장**: 슬레이브는 데이터를 전송한 후 마스터로부터 ACK 응답을 기다림. 마스터가 응답하지 않으면 슬레이브는 데이터를 재전송.

#### 5. 응용 계층 (Application Layer)
- **응용 프로토콜**: 스마트 미터링 또는 산업 자동화 응용을 위한 특화된 프로토콜 사용
- **데이터 암호화**: AES-128 사용

#### 6. 시스템 보안
- **인증**: 슬레이브와 마스터 간의 인증 절차를 통해 신뢰할 수 있는 통신 보장
- **무결성**: 전송되는 데이터의 무결성을 보장하기 위해 HMAC 사용
- **기밀성**: AES 암호화 사용

#### 7. 오류 처리 및 복구
- **오류 검출 및 수정**: CRC 및 Hamming Code 사용
- **재전송 메커니즘**: 오류가 발생한 데이터를 슬레이브가 재전송

### 통신 시나리오 및 타임 슬롯 관리

#### 마스터 -> 슬레이브 통신
1. 마스터는 모든 슬레이브에게 브로드캐스트 메시지를 전송.
2. 마스터는 특정 슬레이브에게 데이터를 전송할 수 있으며, 해당 슬레이브 주소를 지정하여 전송.

#### 슬레이브 -> 마스터 통신
1. 슬레이브는 마스터에게 데이터를 전송하기 위해 주기적으로 할당된 타임 슬롯을 사용.
2. 마스터는 주기적으로 각 슬레이브에게 타임 슬롯을 할당하는 메시지를 브로드캐스트.

#### 타임 슬롯 할당 및 관리
1. **타임 슬롯 할당**:
   - 마스터는 주기적으로 모든 슬레이브에게 타임 슬롯 할당 메시지를 브로드캐스트.
   - 각 슬레이브는 할당된 타임 슬롯 동안에만 데이터를 전송.
2. **충돌 방지**:
   - 슬레이브는 할당된 타임 슬롯 외에 데이터를 전송하지 않음으로써 충돌 방지.
   - 마스터는 타임 슬롯 할당 상태를 모니터링하고 조정.

### 타임 슬롯 통신 예시

1. **다운링크 (마스터 -> 슬레이브)**:
   - 마스터는 타임 슬롯 할당 메시지를 브로드캐스트: [슬레이브1: 0-10ms, 슬레이브2: 10-20ms, ...].
   - 마스터는 모든 슬레이브에게 데이터를 브로드캐스트.

2. **업링크 (슬레이브 -> 마스터)**:
   - 슬레이브1은 할당된 타임 슬롯(0-10ms)에 데이터를 전송.
   - 슬레이브2는 할당된 타임 슬롯(10-20ms)에 데이터를 전송.
   - 두 슬레이브는 동시에 전송하지 않음으로써 충돌을 방지.

3. **동시 전송**:
   - 마스터와 슬레이브는 동시에 데이터를 전송할 수 있으며, 각각의 타임 슬롯에 맞추어 전송을 수행.

이 설계를 통해 주어진 요구 사항을 충족하며 안정적이고 효율적인 DC 전력선 통신을 구현할 수 있습니다. 추가적인 세부 조건이나 요구 사항이 있다면 말씀해 주세요.

## 디자인에 대한 설계
### 양방향 통신 프로토콜 및 알고리즘 설계

### 1. 양방향 통신 프로토콜
#### A. 마스터 -> 슬레이브
- **브로드캐스트 메시지**: 모든 슬레이브에게 전송. 타임 슬롯 할당, 상태 업데이트 등.
- **유니캐스트 메시지**: 특정 슬레이브에게 전송. 데이터 명령, 개별 슬레이브 업데이트 등.

#### B. 슬레이브 -> 마스터
- **타임 슬롯 기반 통신**: 슬레이브는 할당된 타임 슬롯 동안에만 데이터 전송.
- **슬레이브 상태 메시지**: 주기적으로 마스터에게 상태 정보 전송.

### 2. 충돌 방지 및 전송 주기
#### A. 충돌 방지
- **타임 슬롯 할당**: 마스터는 슬레이브에게 타임 슬롯을 할당하여 충돌 방지.
- **슬레이브 전송 타이밍**: 슬레이브는 할당된 타임 슬롯 동안에만 전송. 예를 들어, 10ms 타임 슬롯을 사용하여 100슬레이브에게 각각 10ms 동안 전송할 수 있도록 함.
  
#### B. 전송 주기
- **슬레이브 전송 주기**: 슬레이브는 주기적으로 타임 슬롯 할당 메시지를 수신하고 해당 타임 슬롯 동안에만 전송. 
- **마스터 전송 주기**: 마스터는 주기적으로 모든 슬레이브에게 타임 슬롯 할당 메시지를 전송. 예를 들어, 100슬레이브의 경우 1초 동안 10ms씩 할당하여 순차적으로 전송 가능.

### 3. 비트 오류 처리
- **오류 검출 및 수정 코드**: Hamming Code를 사용하여 비트 오류를 검출하고 수정.
- **CRC (Cyclic Redundancy Check)**: 패킷의 무결성을 검증하기 위해 CRC 사용.

### 4. 패킷 손실 처리
- **ACK/NACK 메커니즘**: 슬레이브가 데이터를 전송한 후 마스터로부터 ACK(전송 성공) 또는 NACK(전송 실패)을 수신.
- **재전송 메커니즘**: NACK를 수신한 경우 슬레이브는 데이터를 재전송. 슬레이브는 일정 시간 후에도 ACK를 수신하지 못하면 재전송 시도.

### 5. 패킷 형식
- **패킷 헤더**:
  - **송신자 주소 (2바이트)**: 송신 슬레이브의 고유 주소.
  - **수신자 주소 (2바이트)**: 수신 마스터 또는 슬레이브의 주소.
  - **프레임 번호 (2바이트)**: 패킷의 순서 번호.
  - **제어 정보 (1바이트)**: 패킷 타입, 우선 순위 등.

- **패킷 페이로드**: 전송할 실제 데이터.
- **패킷 트레일러**: CRC (2바이트)를 포함하여 오류 검출.

### 통신 흐름 예시

#### 마스터 -> 슬레이브
1. **브로드캐스트 메시지**: 모든 슬레이브에게 타임 슬롯 할당 메시지를 전송.
2. **특정 슬레이브 메시지**: 특정 슬레이브에게 개별 명령 또는 데이터를 전송.

#### 슬레이브 -> 마스터
1. **타임 슬롯 전송**: 슬레이브는 할당된 타임 슬롯 동안에만 데이터를 전송.
2. **ACK/NACK 수신**: 슬레이브는 마스터로부터 ACK/NACK를 수신하여 데이터 전송 성공 여부를 확인.

### OSI 2계층 및 3계층 설계

#### 데이터 링크 계층 (2계층)
- **프레이밍**: 패킷을 프레임 단위로 나누어 전송.
- **MAC 주소**: 각 장치는 고유한 MAC 주소를 가짐.
- **타임 슬롯 기반 MAC 프로토콜**: 타임 슬롯을 사용하여 충돌을 방지.

#### 네트워크 계층 (3계층)
- **주소 지정**: 고유한 2바이트 주소를 사용하여 장치를 식별.
- **라우팅**: 마스터가 슬레이브의 데이터를 라우팅.

### 상세 통신 시나리오

#### 주기적 데이터 전송
1. **마스터 타임 슬롯 할당**: 마스터는 매 주기마다 모든 슬레이브에게 타임 슬롯 할당 메시지를 전송.
2. **슬레이브 데이터 전송**: 슬레이브는 할당된 타임 슬롯 동안에만 데이터를 전송.
3. **마스터 ACK/NACK 전송**: 마스터는 슬레이브로부터 데이터를 수신한 후 ACK 또는 NACK를 전송.

#### 비주기적 데이터 전송
1. **이벤트 발생**: 슬레이브에서 이벤트가 발생하면 마스터에게 데이터 전송 요청.
2. **마스터 타임 슬롯 할당**: 마스터는 슬레이브에게 임시 타임 슬롯을 할당하여 데이터 전송.
3. **슬레이브 데이터 전송**: 슬레이브는 할당된 타임 슬롯 동안 데이터를 전송.
4. **마스터 ACK/NACK 전송**: 마스터는 슬레이브로부터 데이터를 수신한 후 ACK 또는 NACK를 전송.

이 설계를 통해 주어진 요구 사항을 충족하며 안정적이고 효율적인 DC 전력선 통신을 구현할 수 있습니다. 추가적인 세부 조건이나 요구 사항이 있다면 말씀해 주세요.


## 추가 요구사항에 대한 설계


### 패킷 형식 설계

#### 프리엠블 (Preamble)
- **목적**: 수신기가 신호를 동기화하고 패킷의 시작을 인식할 수 있도록 도움.
- **구성**: 10101010... 패턴의 반복. (예: 8비트, 16비트 등)

#### 시작 프레임 구분자 (SFD, Start Frame Delimiter)
- **목적**: 프리엠블 끝과 패킷 헤더 시작을 구분.
- **구성**: 고유한 비트 패턴 (예: 11100010)

#### 패킷 헤더 (Header)
- **송신자 주소 (2바이트)**: 송신 슬레이브의 고유 주소.
- **수신자 주소 (2바이트)**: 수신 마스터 또는 슬레이브의 주소.
- **프레임 번호 (2바이트)**: 패킷의 순서 번호.
- **제어 정보 (1바이트)**: 패킷 타입, 우선 순위 등.

#### 패킷 페이로드 (Payload)
- **구성**: 실제 전송할 데이터 (가변 길이).

#### 오류 검출 코드 (CRC, Cyclic Redundancy Check)
- **목적**: 전송 중 발생한 오류를 검출.
- **구성**: CRC-16 (2바이트)

#### 종료 프레임 구분자 (EFD, End Frame Delimiter)
- **목적**: 패킷의 끝을 명확히 표시.
- **구성**: 고유한 비트 패턴 (예: 01111110)

### 패킷 형식 예시

```
[프리엠블] [SFD] [헤더] [페이로드] [CRC] [EFD]
```

- **프리엠블**: 10101010 10101010
- **SFD**: 11100010
- **헤더**: 송신자 주소 (2바이트), 수신자 주소 (2바이트), 프레임 번호 (2바이트), 제어 정보 (1바이트)
- **페이로드**: 실제 데이터 (가변 길이)
- **CRC**: CRC-16 (2바이트)
- **EFD**: 01111110

### 효율적이고 신뢰성 있는 통신을 위한 방법

#### 시간 효율성
- **슬레이브의 대기 시간 최소화**: 슬레이브가 전송을 원하는 경우 마스터로부터 타임 슬롯을 할당받기까지 대기해야 함. 마스터는 슬레이브의 요청을 빠르게 처리하고 타임 슬롯을 할당.
- **슬레이브 간 통신**: 슬레이브는 다른 슬레이브에게 전송할 데이터를 먼저 마스터에게 전송하고, 마스터가 해당 데이터를 수신 슬레이브에게 전달.

#### 다중 슬레이브 전송
- **브로드캐스트 및 멀티캐스트**: 마스터는 특정 그룹의 슬레이브들에게 동시에 메시지를 전송할 수 있도록 멀티캐스트 주소를 사용.
- **타임 슬롯 할당**: 마스터는 슬레이브들에게 타임 슬롯을 할당하여 충돌을 방지. 예를 들어, 슬레이브1은 0-10ms, 슬레이브2는 10-20ms 동안 전송.

### 비트 오류 및 패킷 손실 처리
- **비트 오류 검출 및 수정**: CRC를 사용하여 비트 오류를 검출. 오류가 발견되면 해당 패킷을 재전송.
- **패킷 손실 처리**: ACK/NACK 메커니즘을 사용하여 패킷 손실을 처리. 슬레이브는 마스터로부터 ACK를 수신하지 못하면 데이터를 재전송.

### 예시 통신 시나리오

#### 마스터 -> 슬레이브
1. **브로드캐스트 메시지**: 마스터는 모든 슬레이브에게 타임 슬롯 할당 메시지를 전송.
2. **유니캐스트 메시지**: 특정 슬레이브에게 데이터를 전송.

#### 슬레이브 -> 마스터
1. **타임 슬롯 기반 전송**: 슬레이브는 할당된 타임 슬롯 동안에만 데이터를 전송.
2. **ACK/NACK 수신**: 슬레이브는 마스터로부터 ACK/NACK를 수신하여 데이터 전송 성공 여부를 확인.

### OSI 2계층 및 3계층 설계

#### 데이터 링크 계층 (2계층)
- **프레이밍**: 프리엠블, SFD, EFD를 사용하여 패킷을 프레임 단위로 나누어 전송.
- **MAC 주소**: 각 장치는 고유한 MAC 주소를 가짐.
- **타임 슬롯 기반 MAC 프로토콜**: 타임 슬롯을 사용하여 충돌을 방지.

#### 네트워크 계층 (3계층)
- **주소 지정**: 고유한 2바이트 주소를 사용하여 장치를 식별.
- **라우팅**: 마스터가 슬레이브의 데이터를 라우팅.

이 설계를 통해 주어진 요구 사항을 충족하며 안정적이고 효율적인 DC 전력선 통신을 구현할 수 있습니다. 추가적인 세부 조건이나 요구 사항이 있다면 말씀해 주세요.