# IP: 인터넷 프로토콜 (IP: Internet Protocol)
## IP 데이터그램 구조 (IP Datagram Structure)
- **IP 프로토콜 버전 번호**: IPv4(4) 또는 IPv6(6)와 같이 사용 중인 IP 버전을 나타냄다.
- **헤더 길이**: IP 헤더의 길이를 32비트 단위로 나타냄다.
- **서비스 유형 (Type of Service)**: 패킷의 우선순위와 서비스 품질(QoS)을 지정함다.
- **전체 데이터그램 길이**: IP 헤더와 데이터의 총 길이를 바이트 단위로 나타냄다.
- **식별자, 플래그, 단편 오프셋**: IP 데이터그램이 단편화될 때 사용됨다. 식별자는 각 단편을 고유하게 식별하며, 플래그는 단편화 여부를 나타내고, 단편 오프셋은 각 단편의 위치를 나타냄다.
- **TTL (Time to Live)**: 패킷이 네트워크를 통해 이동할 수 있는 최대 홉 수를 나타냄다. 각 라우터를 통과할 때마다 1씩 감소하며, 0이 되면 패킷은 폐기됨다.
- **프로토콜**: 상위 계층 프로토콜(TCP, UDP 등)을 나타내며, IP 패킷의 페이로드를 처리할 프로토콜을 지정함다.
- **헤더 체크섬**: IP 헤더의 무결성을 확인하기 위해 사용되는 값임다. 헤더의 오류를 검출할 수 있음다.
- **출발지 및 목적지 IP 주소**: 패킷의 출발지와 목적지 IP 주소를 나타냄다.
- **옵션**: 필요한 경우 추가 정보를 제공할 수 있는 필드임다. 예를 들어, 타임스탬프, 경로 기록, 방문할 라우터 목록 등을 지정할 수 있음다.
- **데이터**: IP 데이터그램의 실제 데이터를 포함하며, 가변 길이로 되어 있음다. 일반적으로 TCP 또는 UDP 세그먼트를 포함함다.
- **오버헤드**: IP 헤더(20바이트)와 TCP 헤더(20바이트)를 포함하여 총 40바이트의 오버헤드가 발생함다. 응용 계층의 오버헤드는 이 외에도 추가됨다.

## 관련 용어 (Related Terms)
- **TTL**: 여러 목적이 있지만, 가장 중요한 것은 데이터그램이 영원히 순환하지 않도록 보장하는 것이다.
- **프로토콜**: 네트워크 계층을 전송 계층에 연결하는 역할을 한다.
    - 예: ICMP = 1, TCP = 6, UDP = 17, IPv4 = 4, IPv6 = 41 등.
    - [IANA 프로토콜 번호](https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml)
- **길이**: 16비트로, 헤더와 페이로드를 포함한다.
    - 그러나 IP 패킷은 1500바이트를 초과하는 경우가 드물다, 왜 그럴까?
- **단편화** (다음 페이지 참조)
    - IPv6는 단편화를 허용하지 않는다, 왜 그럴까?			
- **인터넷 체크섬**: IP 헤더에서 오류 검사를 위한 것이다.
    - 각 라우터에서 다시 계산해야 한다, 왜 그럴까?
    - IPv6는 체크섬을 포함하지 않는다, 왜 그럴까? - 더 빠른 라우터를 위해
- **옵션**:
    - IPv6는 옵션을 포함하지 않는다, 왜 그럴까? - 헤더에 option이 없음, data field에 옵션 선택적 추가
## IP 단편화 및 재조립 (IP Fragmentation and Reassembly)
- 네트워크 링크는 MTU(Maximum Transmission Unit)라는 최대 전송 단위를 가진다.
	- MTU: 링크에서 전송할 수 있는 최대 데이터의 크기
	- 타입이 다른 링크 간에는 MTU가 다를 수 있음
- IP 데이터그램이 MTU보다 크면 *단편화*가 발생함
	- 단편화: 큰 IP 데이터그램을 작은 단편으로 나누는 과정
	- 단편화된 패킷은 독립적으로 전송됨
	- 최종 목적지에서만 재조립됨
	- IP 헤더 비트를 사용하여 단편화된 패킷을 식별, 순저 지정함
#### 예시
- MTU: 1500바이트
- IP 데이터그램: 4000바이트
- 단편화된 패킷: 1500바이트, 1500바이트, 1040바이트
	- 첫 번째 단편: 길이-1480, 단편 플래그-1, 단편 오프셋-0
	- 두 번째 단편: 길이-1480, 단편 플래그-1, 단편 오프셋-185=1480/8
	- 세 번째 단편: 길이-1040, 단편 플래그-0, 단편 오프셋-370=2960/8
## IPv4 주소 지정: 개요 (IPv4 Addressing: Overview)
- IP 주소: 호스트, 라우터 *인터페이스*를 위한 32비트 식별자
	- 전역적으로 고유해야 함
	- 일반적으로 점-십진 표기법으로 작성됨
	`<8비트>.<8비트>.<8비트>.<8비트>{:shell}`
- 인터페이스: 호스트 또는 라우터에 연결된 네트워크의 물리적 또는 논리적 연결
	- 라우터는 여러 인터페이스를 가질 수 있음
	- 호스트는 일반적으로 하나 또는 두 개의 인터페이스만 가짐

<Ybox> 인터페이스는 실제로 어떻게 연결되는가? </Ybox>
- 유선 이더넷 인터페이스는 이더넷 스위치를 통해 연결됨
- 무선 WIFI 인터페이스는 WIFI AP(Access Point)를 통해 연결됨

## 서브넷 (Subnets)
- IP 주소:
	- 서브넷 부분 - 높은 비트
	- 호스트 부분 - 낮은 비트
- 서브넷이란?
	- 같은 서브넷 부분의 IP 주소를 가진 호스트들의 집합
	- 라우터 없이 서로 물리적으로 연결 가능
	- 서브넷을 결정하기 위해 각 인터페이스를 호스트나 라우터에서 분리하여 고립된 네트워크 섬을 만든다
	- 각 고립된 네트워크를 서브넷이라 한다
	- "x.x.x.x/Y"에서, /Y는 서브넷 주소에 사용되는 비트 수

## CIDR (Classless Inter-Domain Routing)
- 임의 길이의 서브넷 주소를 지원하는 IP 주소 체계
- 주소 형식: a.b.c.d/x
	- a.b.c.d: IP 주소
	- x: 서브넷 주소에 사용되는 비트 수
- 예시:200.23.16.0/23
	- 서브넷 부분: 23비트 -> *11000000 00010111 0001000*0 00000000
	- 호스트 부분: 32-23=9비트 -> 11000000 00010111 0001000*0 00000000*

## IP 주소: 어떻게 얻는가? (How to Get an IP Address)
- 수동 할당: 관리자가 IP 주소를 수동으로 할당(하드코딩)
- 동적 할당: DHCP(Dynamic Host Configuration Protocol)를 사용하여 IP 주소를 동적으로 할당

### DHCP (Dynamic Host Configuration Protocol)
- 호스트가 네트워크에 연결될 때 IP 주소를 동적으로 할당하는 프로토콜(plug and play)
	- 사용 중인 주소 임대 갱신 가능
	- 주소 재사용 가능
- 개요
	- 호스트가 "DHCP Discover" 메시지를 브로드캐스트 (optional)
	- DHCP 서버가 "DHCP Offer" 메시지를 브로드캐스트 (optional)
	- 호스트가 "DHCP Request" 메시지를 브로드캐스트(IP 주소 요청)
	- DHCP 서버가 "DHCP Ack" 메시지를 브로드캐스트(IP 주소 할당)
![240521-183441](/posts/240521-183441.png)

<Ybox> 네트워크가 서브넷 부분의 IP주소를 어떻게 얻는가? </Ybox>
- 공급자의 ISP 주소 공간에서 할당된 부분을 얻는다

ex) ISP의 블록: *11001000 00010111 0001*0000 00000000 - 200.23.16.0/20
<Ybox> ISP가 주소 블록을 어떻게 얻는가? </Ybox>
- ICANN(Internet Corporation for Assigned Names and Numbers) 또는 지역 인터넷 레지스트리(LIR)로부터 할당받음
	- http://www.icann.org/
	- 주소 할당
	- DNS 관리
	- 도메인 이름 할당, 분쟁 해결

## 계층적 주소 지정: 경로 집계 (Hierarchical Addressing: Route Aggregation)
- 계층적 주소 지정: IP 주소를 계층적으로 구성하여 라우팅 테이블의 크기를 줄임

ex) Fly-By-Night-ISP: "200.23.16.0/20 주소로 시작하는 모든 것을 나에게 보내라"
- Organization 0: 200.23.16.0/23,
- Organization 2: 200.23.20.0/23, ... ,
- Organization 7: 200.23.30.0/23, ...

ex) ISPs-R-Us: "199.31.0.0/16 또는 200.23.18.0/23 주소로 시작하는 모든 것을 나에게 보내라"
- Organization 1: 200.23.18.0/23, ...

## NAT: 네트워크 주소 변환 (Network Address Translation)
- 동기
	- 로컬 네트워크는 단 하나의 IP 주소만 필요함
	- ISP는 각 호스트에 대해 고유한 IP 주소를 할당할 필요가 없음
- 구현: NAT 라우터는 다음을 수행해야 함
	- **나가는 데이터그램**:
			- 모든 나가는 데이터그램의 (소스 IP 주소, 포트 번호)를 (NAT IP 주소, 새로운 포트 번호)로 대체
			- 원격 머신은 (NAT IP 주소, 새로운 포트 번호)를 목적지 주소로 사용하여 응답할 것
	- **기억하기 (NAT 변환 테이블에서)**:
			- 모든 (소스 IP 주소, 포트 번호)를 (NAT IP 주소, 새로운 포트 번호) 변환 쌍으로 기억하기
	- **들어오는 데이터그램**:
			- 모든 들어오는 데이터그램의 목적지 필드를 NAT 테이블에 저장된 해당 (소스 IP 주소, 포트 번호)로 대체

## IPv6: 동기 (IPv6: Motivation)
- 초기 동기
	- 주소 고갈: IPv4(32비트) 주소 고갈 예상
- 추가 동기
	- 헤더 형식이 처리/전달 속도를 높이는 데 도움을 줌
	- Qos(Quality of Service)를 촉진하기 위한 헤더 변경
- IPv6 데이터그램 형식
	- **헤더 길이**: 40바이트로 고정
	- 단편화 없음

## IPv6 데이터그램 구조 (IPv6 Datagram Structure)
- priority: 흐름 내에서 데이터그램의 우선순위를 나타냄
- flow label: 동일한 *흐름*의 데이터그램을 식별함
	- 흐름은 완벽히 정의되지 않음
- next header: 데이터의 상위 계층 프로토콜을 나타냄

## IPv4 에서 IPv6로의 전환 (Transition from IPv4 to IPv6)
- 모든 라우터를 동시에 업그레이드 불가
	- flag day 없음
	- IPv4와 IPv6는 동시에 존재해야 함
- 터널링: IPv6 패킷을 IPv4 패킷에 넣어 전송
	- IPv6 패킷을 IPv4 패킷에 캡슐화하여 전송
	- IPv4 네트워크를 통해 IPv6 패킷을 전송할 수 있음

## 터널링 (Tunneling)
A (IPv6) -> B (IPv6) -> C (IPv4) -> D (IPv4) -> E (IPv6) -> F (IPv6)
- A에서 F로 직접 통신 불가
- A에서 B로 IPv6 패킷 전송
- B에서 C로 IPv4 패킷 전송(*IPv6 패킷을 IPv4 패킷으로 캡슐화*)
- C에서 D로 IPv4 패킷 전송
- D에서 E로 IPv6 패킷 전송(*IPv4 패킷을 IPv6 패킷으로 캡슐화 해제*)
- E에서 F로 IPv6 패킷 전송

